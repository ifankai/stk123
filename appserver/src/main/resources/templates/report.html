<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>小智慧 - 日报</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/css/adminlte.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="/adminlte/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" href="/adminlte/plugins/pace-progress/themes/black/pace-theme-minimal.css">
    <!--    <link rel="stylesheet" href="/css/public.css">-->
    <style>
        @media (min-width: 1200px) {
            .img-width img {
                width: 410px;
                padding: 2px;
            }
            .container{
                max-width: 1350px;
            }
        }
        @media (max-width: 650px) {
            .container{
                min-width: 615px;
            }

        }

        .info-box{
            min-height: unset;
            margin: .1rem .5rem;
            padding: .01rem;
        //font-size: .1rem;
        }
        .table-hotbk .info-box .info-box-content{
            -webkit-flex-direction: inherit;
            -ms-flex-direction: unset;
            flex-direction: unset;
            -webkit-justify-content: unset;
            justify-content: unset;
            line-height:unset;
        }
        .table-hotbk .one{
            font-weight: 500;
            color: var(--danger);
            margin-left: .4rem;
        }
        .callout a{
            text-decoration: none;
            color: unset;
        }
        .callout a:hover{
            color: unset;
        }
        .report-date{
            background-color: #e9eaea;
            color: unset !important;
        }
        .same-bk{
            background-color: #d2d6de;
        }
        .table td.td-hotbk{
            padding: .2rem .5rem;
        }
        .callout-danger a{
            color: var(--danger);
        }
        .callout-hotbk{
            width: 12%;
            margin-left: 2px;
        }
        .callout-hotbk .progress{
            margin: 2px 0 !important;
            height: 5px;
        }
        .callout-hotbk .progress-bar{
            background-color: #f88e8e !important;
        }

        table.dataTable tbody th, table.dataTable tbody td, table.dataTable thead th, table.dataTable thead td {
            padding: 1px 2px;
        }
        div.dataTables_wrapper div.dataTables_info {
            padding-top: .1em;
            float: left;
        }
        div.dataTables_wrapper div.dataTables_filter{
            padding-top: .1em;
            float: right;
            margin-right: .2rem;
        }
        div.dataTables_wrapper div.dataTables_paginate{
            float: right;
        }
        div.dataTables_wrapper div.dataTables_paginate ul.pagination{
            margin: 0;
        }
        .table thead th {
            border-bottom: 1px solid #dee2e6;
            padding: 0 .75rem;
            color: #9ba2a8;
            text-align: center;
            white-space: nowrap;
        }
        table.dataTable>thead .sorting:before,
        table.dataTable>thead .sorting:after,
        table.dataTable>thead .sorting_asc:before,
        table.dataTable>thead .sorting_asc:after,
        table.dataTable>thead .sorting_desc:before,
        table.dataTable>thead .sorting_desc:after,
        table.dataTable>thead .sorting_asc_disabled:before,
        table.dataTable>thead .sorting_asc_disabled:after,
        table.dataTable>thead .sorting_desc_disabled:before,
        table.dataTable>thead .sorting_desc_disabled:after{
            bottom: 0;
        }
        .pagination-sm {
            margin: .1rem 0;
        }
        .custom-select-sm, .form-control-sm {
            height: calc(1.5rem);
            padding-top: .15rem;
            padding-bottom: .25rem;
            padding-left: .5rem;
            font-size: 50%;
        }
        .page-link {
            padding: .2rem .5rem;
            font-size: .8rem;
            line-height: 1.5;
        }

        #report-tabContent label {
            margin-bottom: 0;
        }
        #report-tabContent label:not(.form-check-label):not(.custom-file-label) {
            font-weight: 500;
        }
        .subtable{
            font-size: .2rem;
            text-align: left;
        }
        .subtable th{
            color: #9ba2a8;
            font-size: .15rem;
        }
        .badge-outline {
            border: 1px solid;
        }
        .btn-tab{
            margin-left: 20px;
        }
    </style>
</head>
<body class="hold-transition layout-top-nav layout-navbar-fixed text-sm pace-primary pace-done">
<div class="pace pace-inactive">
    <div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
        <div class="pace-progress-inner"></div>
    </div>
    <div class="pace-activity"></div>
</div>
<!-- Site wrapper -->
<div id="app" class="wrapper">
    <div th:replace="common/navbar"></div>
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header"></section>

        <section class="content">
            <div class="container">
                <div class="row">
                    <div class="col-12">

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">板块统计信息</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="收起">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <nav>
                                    <div class="nav nav-tabs" id="hobk-tab" role="tablist">
                                        <a class="nav-item nav-link active" id="hotbk-calendar-tab" data-toggle="tab" href="#hotbk-calendar" role="tab" aria-controls="hotbk-calendar" aria-selected="true">热点板块日历</a>
                                        <a v-text="reportDate && '板块详情 ['+dateFormat(reportDate)+']'" class="nav-item nav-link" id="hotbk-detail-tab" data-toggle="tab" href="#hotbk-detail" role="tab" aria-controls="hotbk-detail" aria-selected="false"></a>
                                    </div>
                                </nav>
                                <div class="tab-content p-1" id="hotbk-tabContent">
                                    <div class="tab-pane fade show active" id="hotbk-calendar" role="tabpanel" aria-labelledby="hotbk-calendar-tab">
                                        <table class="table table-bordered table-hotbk">
                                            <thead>
                                            <tr>
                                                <th v-for="bk in hotBks" class="text-center text-nowrap" :class="bk.reportDate==reportDate?'report-date':''">
                                                    <a v-text="dateFormat(bk.reportDate)" @click.prevent="gotoReport(bk.reportDate)" href="#" style="color: unset"></a>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr>
                                                <td v-for="bk in hotBks" class="td-hotbk text-center" :class="bk.reportDate==reportDate?'report-date':''">
                                                    <div class="row">
                                                        <section v-for="idx in [0,1]" class="col-lg-6 connectedSortable">
                                                            <template v-for="(item,index) in bk.data">
                                                                    <div v-if="index % 2 === idx" @mouseover="filterSameBk(item)" @mouseleave="filterSameBk({stock:{code:'-1'}})" class="info-box callout" :class="item.class">
                                                                        <div class="callout-hotbk">
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08c')?100+'%':0}">
                                                                                    <span class="sr-only">120日强势板块(08c)</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08b')?60+'%':0}">
                                                                                    <span class="sr-only">60日强势板块(08b)</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08a')?30+'%':0}">
                                                                                    <span class="sr-only">20日强势板块(08a)</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="info-box-content">

                                                                            <span v-html="item.stock.nameWithLink" class="info-box-text"></span>
                                                                            <div v-if="inHotBksNew(item)">
                                                                                <small class="one" title="新出现的板块">new</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                            </template>
                                                        </section>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="tab-pane fade" id="hotbk-detail" role="tabpanel" aria-labelledby="hotbk-detail-tab">
                                        <datatable :="{...common.currentHotBks, ...currentHotBks}"></datatable>
                                    </div>
                                </div>
                            </div>
                        </div>

                                    <div class="card">
                                        <div class="card-header">
                                            <h3 v-text="reportDate && '股票统计信息 ['+dateFormat(reportDate)+']'" class="card-title"></h3>
                                            <div class="card-tools">
                                                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="收起">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="card-body">
                                            <nav>
                                                <div class="nav nav-tabs" id="report-tab" role="tablist">
                                                    <a class="nav-item nav-link active" id="report-allstocks-tab" data-toggle="tab" href="#report-allstocks" role="tab" aria-controls="report-allstocks" aria-selected="true">
                                                        全市场策略
                                                        <span v-text="currentAllStocks.data.length" class="badge badge-outline"></span>
                                                    </a>
                                                    <a class="nav-item nav-link" id="report-mystocks-a-tab" data-toggle="tab" href="#report-mystocks-a" role="tab" aria-controls="report-mystocks-a" aria-selected="false">
                                                        自选股策略(A股)
                                                        <span v-text="currentMyStocksA.data.length" class="badge badge-outline"></span>
                                                    </a>
                                                    <a class="nav-item nav-link" id="report-mystocks-h-tab" data-toggle="tab" href="#report-mystocks-h" role="tab" aria-controls="report-mystocks-h" aria-selected="false">
                                                        自选股策略(H股)
                                                        <span v-text="currentMyStocksH.data.length" class="badge badge-outline"></span>
                                                    </a>
                                                    <a class="nav-item nav-link" id="report-mystocks-u-tab" data-toggle="tab" href="#report-mystocks-u" role="tab" aria-controls="report-mystocks-u" aria-selected="false">
                                                        自选股策略(美股)
                                                        <span v-text="currentMyStocksU.data.length" class="badge badge-outline"></span>
                                                    </a>
                                                    <span class="btn-tab">
                                            <button type="button" class="btn btn-outline-primary btn-xs" style="margin-bottom: -11px;"><i class="fas fa-th"></i> 查看全部</button>
                                        </span>
                                                </div>

                                            </nav>

                                            <div class="tab-content p-1" id="report-tabContent">
                                                <div class="tab-pane fade show active" id="report-allstocks" role="tabpanel" aria-labelledby="report-allstocks-tab">
                                                    <datatable :="{...common.allStocks, ...currentAllStocks}"></datatable>
                                                </div>
                                                <div class="tab-pane fade" id="report-mystocks-a" role="tabpanel" aria-labelledby="report-mystocks-a-tab">
                                                    <datatable :="{...common.allStocks, ...currentMyStocksA}"></datatable>
                                                </div>
                                                <div class="tab-pane fade" id="report-mystocks-h" role="tabpanel" aria-labelledby="report-mystocks-h-tab">
                                                    <datatable :="{...common.allStocks, ...currentMyStocksH}"></datatable>
                                                </div>
                                                <div class="tab-pane fade" id="report-mystocks-u" role="tabpanel" aria-labelledby="report-mystocks-u-tab">
                                                    <datatable :="{...common.allStocks, ...currentMyStocksU}"></datatable>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                </div>
            </div>
        </section>

            <a id="back-to-top" href="#" class="btn btn-outline-primary back-to-top" style="display: none" role="button" aria-label="Scroll to top">
                <i class="fas fa-chevron-up"></i>
            </a>
    </div>

    <div th:replace="common/footer"></div>
</div>
<!-- ./wrapper -->
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.1.1/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>

<script src="/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/pace-progress/pace.min.js"></script>

<script src="/js/public.js"></script>
<script src="/js/component/datatable.js"></script>

<script th:inline="javascript">
    const reportDate = [[${reportDate}]];

    const app = Vue.createApp({
        data() {
            return {
                loading: true,
                reportDate: '',
                common:{
                    hotBks:[{type:'strategy_08a', name:'20日强势板块(08a)'},{type:'strategy_08b', name:'60日强势板块(08b)'},{type:'strategy_08c', name:'120日强势板块(08c)'}],
                    currentHotBks:{
                        columns: [
                            {title:"板块", data:"nameAndCodeWithLink"},
                            {title:"日期/策略", data:"strategyDateAndCode"},
                            {title:"日线", data:"dayBarImage"},
                            {title:"周线", data:"weekBarImage"},
                            {title:"精选个股", data:"bkStocks"},
                            {title:"操作", data:"action"}
                        ],
                        ordering: false,
                        columnDefs: [
                            { className: "text-nowrap text-center", "targets": [ 0,1,4,5 ] },
                            { className: "img-width", "targets": [ 2,3 ] }
                        ]
                    },
                    allStocks:{
                        columns: [
                            {title:"股票/日期/策略/板块", data:"stockAndBk"},
                            {title:"策略输出", data:"strategyOutput"},
                            {title:"日线", data:"dayBarImage"},
                            {title:"周线", data:"weekBarImage"}
                        ],
                        ordering: false,
                        columnDefs: [
                            { className: "text-center", "targets": [ 0 ] }, //text-nowrap
                            { className: "img-width", "targets": [ 2,3 ] }
                        ]
                    }
                },
                hotBks:[],
                hotBksNew:[],
                currentHotBks:{
                    data:[]
                },
                currentHotBks:{data:[]},currentAllStocks:{data:[]},
                currentMyStocksA:{data:[]},currentMyStocksH:{data:[]},currentMyStocksU:{data:[]},
            }
        },
        methods:{
            filterSameBk:function (item) {
                this.hotBks.forEach(bk => bk.data.forEach(itm => itm.class=(item.stock.code === itm.stock.code?'callout-danger':'') ));
            },
            inHotBksNew:function (item) {
                return this.hotBksNew.indexOf(item.stock.code) >= 0;
            },
            dateFormat:function (date){
                return dateFormat(date);
            },
            gotoReport:function (reportDate) {
                window.open('/report/'+reportDate);
            }
        },
        computed: {
            reportDateShow:function (){
                return dateFormat(this.reportDate);
            }
        },
    mounted() {
        let _this = this;
        axios.get("/rpt/"+reportDate).then(function (res) {
            let data = res.data.data;
            _this.reportDate = data.reportDate;
            _this.hotBks = data.hotBks;
            _this.hotBksNew = data.hotBksNew;
            data.currentHotBks.forEach((item, index) => {
                Object.assign(data.currentHotBks[index], item.bk)
                data.currentHotBks[index].strategyDateAndCode = dateFormat(data.currentHotBks[index].strategyDate) + '<br/>(' +item.details.map(detail => detail.strategyCode.split('_')[1]).join(', ') +')';
                data.currentHotBks[index].bkStocks = data.currentHotBks[index].details[0].stocks.map(detail => detail.nameWithLink).join('<br/>');
                data.currentHotBks[index].action = data.currentHotBks[index].details[0].action;
            });
            _this.currentHotBks = {data: data.currentHotBks};
            _this.currentAllStocks = {data: data.currentAllStocks};
            _this.currentAllStocks.data = convertStocks(_this.currentAllStocks.data);
            _this.currentMyStocksA = {data: data.currentMyStocksA};
            _this.currentMyStocksA.data = convertStocks(_this.currentMyStocksA.data);
            _this.currentMyStocksH = {data: data.currentMyStocksH};
            _this.currentMyStocksH.data = convertStocks(_this.currentMyStocksH.data);
            _this.currentMyStocksU = {data: data.currentMyStocksU};
            _this.currentMyStocksU.data = convertStocks(_this.currentMyStocksU.data);

            console.log('mounted', _this.$data)
        });
    }
    });

    app.component('datatable', _datatable);
    app.mount('#app');

    function convertStocks(data){
        data.forEach(stock =>{
            /*if(stock.bks) {
                let bkRows = stock.bks.map(bk =>
                    '<tr><td>' + bk.bk.nameWithLink + '<br/><a title="查看板块精选个股" target="_blank" href="/S/'+bk.bkRpsStockCode+'"><i class="fas fa-th"></i></a></td><td>' + bk.bkRpsName + '<br/>' + bk.bkRpsPercentile + '</td>'
                )
                stock.bksHtml = '<table class="subtable text-nowrap"><tr><th>板块</th><th>策略/百分位</th></tr>' + bkRows.join('') + '</table>'
            }else{
                stock.bksHtml = ''
            }*/

            if(stock.bks) {
                stock.bksHtml = '<table class="subtable text-nowrap">' +
                    '<tr><td>板块</td>'+ stock.bks.map(bk => '<td class="text-center">'+bk.bk.nameWithLink+'</td>').join('') + '</tr>'+
                    '<tr><td>策略</td>'+ stock.bks.map(bk => '<td class="text-center">'+bk.bkRpsName+'</td>').join('') + '</tr>'+
                    '<tr><td>百分位</td>'+ stock.bks.map(bk => '<td class="text-center">'+bk.bkRpsPercentile+'</td>').join('') + '</tr>'+
                    '<tr><td>查看</td>'+ stock.bks.map(bk => '<td class="text-center"><a title="查看板块精选个股" target="_blank" href="/S/'+bk.bkRpsStockCode+'"><i class="fas fa-th"></i></a></td>').join('') + '</tr>'+
                    '</table>';
            }else{
                stock.bksHtml = ''
            }
            stock.stockAndBk = '<table><tr><td>'+stock.nameAndCodeWithLink + '</td></tr>' +
                '<tr><td>' + dateFormat(stock.strategyDate) + '</td></tr>' +
                '<tr><td>策略：' + stock.strategyName + '</td></tr>' + '<tr><td>&nbsp;</td></tr>' +
                '<tr><td>' + stock.bksHtml + '</td></tr></table>';
        })
        return data;
    }
</script>