<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>小智慧 - 日报</title>
    <div th:replace="common/css_public"></div>
    <div th:replace="common/css_datatable"></div>
    <!--    <link rel="stylesheet" href="/css/public.css">-->
    <style>
        @media (min-width: 1200px) {
            .img-width img {
                width: 410px;
                padding: 2px;
                text-align: center;
            }
            .container{
                max-width: 1350px;
            }
        }
        @media (max-width: 650px) {
            .container{
                min-width: 615px;
            }

        }

        .info-box{
            min-height: unset;
            margin: .1rem 0;
            padding: .01rem;
        }
        .table-hotbk .info-box .info-box-content{
            -webkit-flex-direction: inherit;
            -ms-flex-direction: unset;
            flex-direction: unset;
            -webkit-justify-content: unset;
            justify-content: unset;
            line-height:unset;
            padding-left: .3rem;
            font-size: 1vw;
        }
        .info-box-content:after{
            clear:both;
        }
        .table-hotbk .one{
            font-weight: 500;
            color: var(--danger);
            margin-left: .2rem;
        }
        .callout a{
            text-decoration: none;
            color: unset;
            font-size: .85rem;
        }
        .callout a:hover{
            color: unset;
        }
        .report-date{
            background-color: #e9eaea;
            color: unset !important;
        }
        .same-bk{
            background-color: #d2d6de;
        }
        .table td.td-hotbk{
            padding: .2rem .8rem;
        }
        .callout-danger a{
            color: var(--danger);
        }
        .callout-hotbk{
            width: 12%;
            min-width: 15px;
            margin-left: 2px;
        }
        .callout-hotbk .progress{
            margin: 2px 0 !important;
            height: 5px;
        }
        .callout-hotbk .progress-bar{
            background-color: #f88e8e !important;
        }

        table.dataTable tbody th, table.dataTable tbody td, table.dataTable thead th, table.dataTable thead td {
            padding: 1px 2px;
        }
        div.dataTables_wrapper div.dataTables_info {
            padding-top: .1em;
            float: left;
        }
        div.dataTables_wrapper div.dataTables_filter{
            padding-top: .1em;
            float: right;
            margin-right: .2rem;
        }
        div.dataTables_wrapper div.dataTables_paginate{
            float: right;
        }
        div.dataTables_wrapper div.dataTables_paginate ul.pagination{
            margin: 0;
        }
        .table thead th {
            border-bottom: 1px solid #dee2e6;
            padding: 0 .75rem;
            color: #9ba2a8;
            text-align: center;
            white-space: nowrap;
        }
        table.dataTable>thead .sorting:before,
        table.dataTable>thead .sorting:after,
        table.dataTable>thead .sorting_asc:before,
        table.dataTable>thead .sorting_asc:after,
        table.dataTable>thead .sorting_desc:before,
        table.dataTable>thead .sorting_desc:after,
        table.dataTable>thead .sorting_asc_disabled:before,
        table.dataTable>thead .sorting_asc_disabled:after,
        table.dataTable>thead .sorting_desc_disabled:before,
        table.dataTable>thead .sorting_desc_disabled:after{
            bottom: 0;
        }
        .pagination-sm {
            margin: .1rem 0;
        }
        .custom-select-sm, .form-control-sm {
            height: calc(1.5rem);
            padding-top: .15rem;
            padding-bottom: .25rem;
            padding-left: .5rem;
            font-size: 50%;
        }
        .page-link {
            padding: .2rem .5rem;
            font-size: .8rem;
            line-height: 1.5;
        }

        #report-tabContent label {
            margin-bottom: 0;
        }
        #report-tabContent label:not(.form-check-label):not(.custom-file-label) {
            font-weight: 500;
        }
        .subtable{
            font-size: .8rem;
            text-align: left;
            margin: auto;
        }
        .subtable th{
            color: #9ba2a8;
            font-size: .15rem;
        }
        .badge-outline {
            border: 1px solid;
        }
        .btn-tab{
            margin-left: 20px;
        }
        .ps{
            margin-left: 5px;
            font-size: .8vw;
            float: left;
            margin-top: 3px;
            color: #6c757d;
        }
</style>
</head>
<body class="hold-transition layout-top-nav layout-navbar-fixed text-sm pace-primary pace-done">
<div class="pace pace-inactive">
    <div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
        <div class="pace-progress-inner"></div>
    </div>
    <div class="pace-activity"></div>
</div>
<!-- Site wrapper -->
<div id="app" class="wrapper">
    <div th:replace="common/navbar"></div>
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header"></section>

        <section class="content">
            <div class="container">
                <div class="row">
                    <div class="col-12">

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" id="bk-stat">板块统计信息</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="收起">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <nav>
                                    <div class="nav nav-tabs" id="hobk-tab" role="tablist">
                                        <a class="nav-item nav-link active" id="hotbk-calendar-tab" data-toggle="tab" href="#hotbk-calendar" role="tab" aria-controls="hotbk-calendar" aria-selected="true">热点板块日历</a>
                                        <a v-text="reportDate && '板块详情 ['+dateFormat(reportDate)+']'" class="nav-item nav-link" id="hotbk-detail-tab" data-toggle="tab" href="#hotbk-detail" role="tab" aria-controls="hotbk-detail" aria-selected="false"></a>
                                        <a v-text="reportDate && '板块策略 ['+dateFormat(reportDate)+']'" class="nav-item nav-link" id="allbks-strategy-tab" data-toggle="tab" href="#allbks-strategy" role="tab" aria-controls="allbks-strategy" aria-selected="false"></a>
                                    </div>
                                </nav>
                                <div class="tab-content p-1" id="hotbk-tabContent">
                                    <div class="tab-pane fade show active" id="hotbk-calendar" role="tabpanel" aria-labelledby="hotbk-calendar-tab">
                                        <table class="table table-bordered table-hotbk">
                                            <thead>
                                            <tr>
                                                <th v-for="bk in hotBks" class="text-center text-nowrap" :class="bk.reportDate==reportDate?'report-date':''">
                                                    <a v-text="dateFormat(bk.reportDate)" @click.prevent="gotoReport(bk.reportDate)" href="#" style="color: unset"></a>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td v-for="bk in hotBks" class="td-hotbk text-center" :class="bk.reportDate==reportDate?'report-date':''">
                                                        <div class="row">
                                                            <section v-for="idx in [0,1]" class="col-lg-6 connectedSortable" style="padding: 0 3px">
                                                                <template v-for="(item,index) in bk.data">
                                                                    <div v-if="index % 2 === idx" @mouseover="filterSameBk(item)" @mouseleave="filterSameBk({stock:{code:'-1'}})" class="info-box callout" :class="item.class">
                                                                        <div class="callout-hotbk">
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08c')?100+'%':0}">
                                                                                    <span class="sr-only">120日强势板块(08c)</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08b')?60+'%':0}">
                                                                                    <span class="sr-only">60日强势板块(08b)</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="progress">
                                                                                <div class="progress-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" :style="{width: item.strategies.includes('strategy_08a')?30+'%':0}">
                                                                                    <span class="sr-only">20日强势板块(08a)</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="info-box-content">
                                                                            <span v-html="item.stock.nameWithLink" class="info-box-text"></span>
                                                                            <div v-if="inHotBksNew(item)">
                                                                                <small class="one" title="新出现的板块">new</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                </template>
                                                            </section>
                                                        </div>
                                                    </td>
                                                </tr>

                                            </tbody>
                                        </table>

                                        <div class="tab-custom-content">
                                            <span class="ps">说明: </span>
                                            <span class="lead mb-0 text-sm">
                                                <div class="callout-hotbk" style="max-width: 18px;margin-left: 5px; float: left">
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><span class="sr-only">120日强势板块(08c)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">60日强势板块(08b)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">20日强势板块(08a)</span></div></div>
                                                </div>
                                            </span>
                                            <span class="ps">120日强势板块(08c)</span>
                                            <span class="lead mb-0 text-sm">
                                                <div class="callout-hotbk" style="max-width: 18px;margin-left: 15px; float: left">
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">120日强势板块(08c)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%"><span class="sr-only">60日强势板块(08b)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">20日强势板块(08a)</span></div></div>
                                                </div>
                                            </span>
                                            <span class="ps">60日强势板块(08b)</span>
                                            <span class="lead mb-0 text-sm">
                                                <div class="callout-hotbk" style="max-width: 18px;margin-left: 15px; float: left">
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">120日强势板块(08c)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0"><span class="sr-only">60日强势板块(08b)</span></div></div>
                                                    <div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width: 30%"><span class="sr-only">20日强势板块(08a)</span></div></div>
                                                </div>
                                            </span>
                                            <span class="ps">20日强势板块(08a)</span>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="hotbk-detail" role="tabpanel" aria-labelledby="hotbk-detail-tab">
                                        <datatable :="{...common.currentHotBks, ...currentHotBks}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="allbks-strategy" role="tabpanel" aria-labelledby="allbks-strategy-tab">
                                        <datatable :="{...common.currentHotBks, ...currentBksStrategy}"></datatable>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 v-text="reportDate && '股票统计信息 ['+dateFormat(reportDate)+']'" class="card-title"></h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="收起">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <nav>
                                    <div class="nav nav-tabs" id="report-tab" role="tablist">
                                        <a @click="clickTab(currentAllStocks.data)" class="nav-item nav-link active" id="report-allstocks-tab" data-toggle="tab" href="#report-allstocks" role="tab" aria-controls="report-allstocks" aria-selected="true">
                                            全市场策略 (<span v-text="currentAllStocks.data.length"></span>)
                                        </a>
                                        <a @click="clickTab([])" class="nav-item nav-link" id="report-allstocksrps-tab" data-toggle="tab" href="#report-allstocksrps" role="tab" aria-controls="report-allstocksrps" aria-selected="false">
                                            全市场策略RPS
                                        </a>
                                        <a @click="clickTab(currentAllStocksRpsStrategy.data)" class="nav-item nav-link" id="report-allstocksrpsstrategy-tab" data-toggle="tab" href="#report-allstocksrpsstrategy" role="tab" aria-controls="report-allstocksrpsstrategy" aria-selected="false">
                                            全市场策略RPS+策略 (<span v-text="currentAllStocksRpsStrategy.data.length"></span>)
                                        </a>
                                        <a @click="clickTab(currentMyStocksA.data)" class="nav-item nav-link" id="report-mystocks-a-tab" data-toggle="tab" href="#report-mystocks-a" role="tab" aria-controls="report-mystocks-a" aria-selected="false">
                                            自选股策略[A股] (<span v-text="currentMyStocksA.data.length"></span>)
                                        </a>
                                        <a @click="clickTab(currentMyStocksH.data)" class="nav-item nav-link" id="report-mystocks-h-tab" data-toggle="tab" href="#report-mystocks-h" role="tab" aria-controls="report-mystocks-h" aria-selected="false">
                                            自选股策略[H股] (<span v-text="currentMyStocksH.data.length"></span>)
                                        </a>
                                        <a @click="clickTab(currentMyStocksU.data)" class="nav-item nav-link" id="report-mystocks-u-tab" data-toggle="tab" href="#report-mystocks-u" role="tab" aria-controls="report-mystocks-u" aria-selected="false">
                                            自选股策略[美股] (<span v-text="currentMyStocksU.data.length"></span>)
                                        </a>
                                        <span class="btn-tab">
                                            <button v-show="currentTabSize!=0" @click="gotoStocks()" type="button" class="btn btn-outline-primary btn-xs" style="margin-bottom: -11px;"><i class="fas fa-th"></i> <span v-text="'查看全部'+currentTabSize+'只个股'"></span></button>
                                        </span>
                                    </div>

                                </nav>

                                <div class="tab-content p-1" id="report-tabContent">
                                    <div class="tab-pane fade show active" id="report-allstocks" role="tabpanel" aria-labelledby="report-allstocks-tab">
                                        <datatable :="{...common.allStocks, ...currentAllStocks}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="report-allstocksrps" role="tabpanel" aria-labelledby="report-allstocksrps-tab">
                                        <datatable :="{...common.allStocksRps, ...currentAllStocksRps}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="report-allstocksrpsstrategy" role="tabpanel" aria-labelledby="report-allstocksrpsstrategy-tab">
                                        <datatable :="{...common.allStocks, ...currentAllStocksRpsStrategy}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="report-mystocks-a" role="tabpanel" aria-labelledby="report-mystocks-a-tab">
                                        <datatable :="{...common.allStocks, ...currentMyStocksA}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="report-mystocks-h" role="tabpanel" aria-labelledby="report-mystocks-h-tab">
                                        <datatable :="{...common.allStocks, ...currentMyStocksH}"></datatable>
                                    </div>
                                    <div class="tab-pane fade" id="report-mystocks-u" role="tabpanel" aria-labelledby="report-mystocks-u-tab">
                                        <datatable :="{...common.allStocks, ...currentMyStocksU}"></datatable>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>

        <a id="back-to-top" href="#" class="btn btn-outline-primary back-to-top" style="display: none" role="button" aria-label="Scroll to top">
            <i class="fas fa-chevron-up"></i>
        </a>
    </div>

    <div th:replace="common/footer"></div>
</div>
<!-- ./wrapper -->
</body>
</html>
<div th:replace="common/js_public"></div>
<div th:replace="common/js_datatable"></div>
<div th:replace="common/js_custom"></div>

<script th:inline="javascript">
    const reportDate = [[${reportDate}]];

    const config = {
        data() {
            return {
                loading: true,
                reportDate: '',
                currentTabSize:0,
                currentTabStocks:'',
                common:{
                    hotBks:[{type:'strategy_08a', name:'20日强势板块(08a)'},{type:'strategy_08b', name:'60日强势板块(08b)'},{type:'strategy_08c', name:'120日强势板块(08c)'}],
                    currentHotBks:{
                        columns: [
                            {title:"板块/日期/策略", data:"bkDateStrategy"},
                            {title:"日线", data:"dayBarImage"},
                            {title:"周线", data:"weekBarImage"},
                            {title:"精选个股", data:"bkStocks"},
                            {title:"操作", data:"action"}
                        ],
                        columnDefs: [
                            { className: "text-nowrap text-center", "targets": [ 0,3,4 ] },
                            { className: "img-width text-center", "targets": [ 1,2 ] }
                        ]
                    },
                    allStocks:{
                        columns: [
                            {title:"股票/日期/策略/板块", data:"stockAndBk"},
                            {title:"策略输出", data:"strategyOutput"},
                            {title:"日线", data:"dayBarImage"},
                            {title:"周线", data:"weekBarImage"}
                        ],
                        columnDefs: [
                            { className: "text-center", "targets": [ 0 ] }, //text-nowrap
                            { className: "img-width", "targets": [ 2,3 ] }
                        ],
                        pageLength: 50
                    },
                    allStocksRps:{
                        columns: [
                            {title:"策略", data:"strategyName"},
                            {title:"日期", data:"strategyDate"},
                            {title:"操作", data:"action"}
                        ],
                        paging:   false,
                        info: false,
                        searching : false,
                        columnDefs: [
                            { className: "text-center", "targets": [ 0,1,2 ] }
                        ],
                        tableClass:{'table-hover':true}
                    }
                },
                hotBks:[],
                hotBksNew:[],
                currentHotBks:{
                    data:[]
                },
                currentHotBks:{data:[]},currentAllStocks:{data:[]},currentBksStrategy:{data:[]},
                currentMyStocksA:{data:[]},currentMyStocksH:{data:[]},currentMyStocksU:{data:[]},
                currentAllStocksRps:{data:[]},currentAllStocksRpsStrategy:{data:[]}
            }
        },
        methods:{
            filterSameBk:function (item) {
                this.hotBks.forEach(bk => bk.data.forEach(itm => itm.class=(item.stock.code === itm.stock.code?'callout-danger':'') ));
            },
            inHotBksNew:function (item) {
                return this.hotBksNew.indexOf(item.stock.code) >= 0;
            },
            dateFormat:function (date){
                return dateFormat(date);
            },
            gotoReport:function (reportDate) {
                window.open('/report/'+reportDate);
            },
            gotoStocks:function (){
                console.log(this.currentTabStocks)
                window.open('/S/'+this.currentTabStocks);
            },
            clickTab:function (data) {
                this.currentTabSize = data.length;
                this.currentTabStocks = data.map(d => d.code).join(',');
            }
        },
        computed: {
            reportDateShow:function (){
                return dateFormat(this.reportDate);
            }
        },
        mounted() {
            let _this = this;
            axios.get("/rpt/"+reportDate).then(function (res) {
                let data = res.data.data;
                _this.reportDate = data.reportDate;
                _this.hotBks = data.hotBks;
                _this.hotBksNew = data.hotBksNew;
                data.currentHotBks.forEach((item, index) => {
                    Object.assign(item, item.bk)
                    item.bkDateStrategy = item.nameAndCodeWithLink + '<br/>' + dateFormat(item.strategyDate) + '<br/>(' +item.details.map(detail => detail.strategyCode.split('_')[1]).join(', ') +')';
                    item.bkStocks = item.details[0].stocks.map(detail => detail.nameWithLink).join('<br/>');
                    item.action = item.details[0].action;
                });
                _this.currentHotBks = {data: data.currentHotBks};

                data.currentBksStrategy.forEach((item, index) => {
                    Object.assign(item, item.bk)
                    item.bkDateStrategy = item.nameAndCodeWithLink + '<br/>' + dateFormat(item.strategyDate) + '<br/>' +item.details.map(detail => detail.strategyName).join('<br/>');
                    item.bkStocks = item.details[0].stocks.map(detail => detail.nameWithLink).join('<br/>');
                    item.action = item.details[0].action;
                });
                _this.currentBksStrategy = {data: data.currentBksStrategy};

                _this.currentAllStocks = {data: data.currentAllStocks};
                _this.currentAllStocks.data = convertStocks(_this.currentAllStocks.data);
                _this.currentTabSize = _this.currentAllStocks.data.length;
                _this.currentTabStocks = _this.currentAllStocks.data.map(d => d.code).join(',');

                _this.currentAllStocksRpsStrategy = {data: data.currentAllStocksRpsStrategy};
                _this.currentMyStocksA = {data: data.currentMyStocksA};
                _this.currentMyStocksH = {data: data.currentMyStocksH};
                _this.currentMyStocksU = {data: data.currentMyStocksU};

                _this.currentAllStocksRps = {data: data.currentAllStocksRps};
                _this.currentAllStocksRps.data.forEach(item => {
                    item.strategyDate = dateFormat(item.strategyDate);
                    item.action = elem('a', {href:'/S/'+item.rpsStockCode, target:'_blank'}, '查看全部').outerHTML;
                })
                console.log('mounted', _this.$data)
            });

            store.commit('setStockLookPool', getDataFromLocalStorage('stockLookPool') || []);
        }
    };
    createApp(config);

    function convertStocks(data){
        data.forEach(stock =>{
            stock.stockAndBk = {table:true}
        })
        return data;
    }

    function createTableOrNot(name, data){
        if(data.length <= 1){
            return name + '：'+ data;
        }else{
            return '<table><tr><td rowspan="'+data.length+'">策略</td><td>'+data[0]+'</td></tr>' +
                data.slice(1).map(d => '<tr><td>'+d+'</td></tr>').join('')+
                '</table>'
        }
    }
</script>